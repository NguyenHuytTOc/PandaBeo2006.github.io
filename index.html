// ====== PRODUCT DATA ======
function getAllProducts() {
    return [
        // Sản phẩm Nam
        {
            id: 1,
            name: "Áo Thun Dirty Coins Oversize Basic",
            category: "nam",
            price: 550000,
            originalPrice: 650000,
            images: [
                "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
            ],
            sizes: ["S", "M", "L", "XL", "XXL"],
            colors: [
                {name: "Đen", code: "#000000"},
                {name: "Trắng", code: "#ffffff"}
            ],
            material: "cotton",
            brand: "Dirty Coins",
            tags: ["hot", "new"],
            description: "Áo thun oversize basic từ Dirty Coins với chất liệu cotton 100% mềm mại, thoáng mát."
        },
        // Thêm các sản phẩm khác ở đây...
    ];
}

// ====== INITIALIZATION ======
document.addEventListener('DOMContentLoaded', function() {
    // Khởi tạo filter mặc định
    document.querySelectorAll('[data-value="all"]').forEach(el => {
        el.classList.add('active');
    });
    
    // Hiển thị trang chủ ban đầu
    showPage('home');
    
    // Cập nhật số lượng giỏ hàng
    updateCartCount();
    
    // Hiển thị tên người dùng nếu đã đăng nhập
    if (currentUser) {
        updateUserInfo();
    }
    
    // Khởi tạo ngày tháng năm cho form đăng ký
    initDateSelectors();
    
    // Load sản phẩm cho tất cả các trang
    loadAllProducts();
});

// ====== LOAD ALL PRODUCTS ======
function loadAllProducts() {
    loadShopProducts();
    loadNamProducts();
    loadNuProducts();
    loadTreEmProducts();
    loadPhuKienProducts();
}

// ====== CART FUNCTIONS - SỬA LỖI LOCALSTORAGE ======
function addToCart(productId) {
    event.stopPropagation();
    
    const product = getAllProducts().find(p => p.id === productId);
    if (!product) return;
    
    // Kiểm tra xem sản phẩm đã có trong giỏ chưa
    const existingItemIndex = cart.findIndex(item => item.id === productId);
    
    if (existingItemIndex > -1) {
        // Nếu đã có, tăng số lượng
        cart[existingItemIndex].quantity += 1;
    } else {
        // Nếu chưa có, thêm mới
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            image: product.images[0],
            quantity: 1
        });
    }
    
    // Lưu vào localStorage với đúng key
    localStorage.setItem('pandabeo_cart', JSON.stringify(cart));
    
    // Cập nhật UI
    updateCartCount();
    
    // Hiển thị thông báo
    showNotification('Đã thêm sản phẩm vào giỏ hàng!');
    
    // Nếu đang mở modal giỏ hàng, cập nhật nội dung
    if (document.getElementById('cartModal').classList.contains('active')) {
        renderCartItems();
        updateCartSummary();
    }
}

// ====== RENDER CART ITEMS - SỬA LỖI EVENT ======
function renderCartItems() {
    const cartItemsContainer = document.getElementById('cartItems');
    
    if (cart.length === 0) {
        cartItemsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-shopping-cart" style="font-size: 48px; color: var(--gray-light); margin-bottom: 20px;"></i>
                <h3>Giỏ hàng trống</h3>
                <p>Hãy thêm sản phẩm vào giỏ hàng</p>
            </div>
        `;
        return;
    }
    
    cartItemsContainer.innerHTML = cart.map(item => `
        <div class="cart-item">
            <div class="cart-item-image">
                <img src="${item.image}" alt="${item.name}">
            </div>
            <div class="cart-item-info">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">${item.price.toLocaleString()}đ</div>
            </div>
            <div class="cart-item-actions">
                <div class="quantity-control">
                    <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                    <span class="quantity">${item.quantity}</span>
                    <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                </div>
                <div class="cart-remove" onclick="removeFromCart(${item.id})">
                    <i class="fas fa-trash"></i>
                </div>
            </div>
        </div>
    `).join('');
}

// ====== DISPLAY PRODUCTS - SỬA LỖI HIỂN THỊ ======
function displayProducts(products, page = 'shop') {
    const productGrid = document.getElementById(page + 'ProductGrid');
    if (!productGrid) {
        console.error('Product grid not found for page:', page);
        return;
    }
    
    if (!products || products.length === 0) {
        productGrid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                <i class="fas fa-search" style="font-size: 3rem; color: var(--gray); margin-bottom: 1rem;"></i>
                <h3>Không tìm thấy sản phẩm phù hợp</h3>
                <p>Vui lòng thử lại với bộ lọc khác</p>
            </div>
        `;
        return;
    }
    
    productGrid.innerHTML = products.map(product => {
        // Xử lý badges an toàn
        let badges = '';
        if (product.tags && product.tags.length > 0) {
            badges = product.tags.map(tag => {
                if (tag === 'new') return '<span class="badge badge-new">Mới</span>';
                if (tag === 'sale' && product.originalPrice && product.originalPrice > product.price) {
                    const discount = Math.round((1 - product.price/product.originalPrice) * 100);
                    return `<span class="badge badge-sale">-${discount}%</span>`;
                }
                if (tag === 'hot') return '<span class="badge badge-hot">Hot</span>';
                return '';
            }).filter(badge => badge !== '').join('');
        }
        
        const originalPrice = product.originalPrice && product.originalPrice > product.price ? 
            `<span class="original-price">${product.originalPrice.toLocaleString()}đ</span>` : '';
        
        // Đảm bảo có ảnh
        const productImage = product.images && product.images[0] ? product.images[0] : 
            'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80';
        
        return `
            <div class="product-card">
                <div class="product-badges">
                    ${badges}
                </div>
                <div class="product-image">
                    <img src="${productImage}" alt="${product.name}" loading="lazy">
                    <button class="quick-view" onclick="showProductDetail(${product.id})">Xem Nhanh</button>
                </div>
                <div class="product-info">
                    <div class="product-category">${product.brand || 'Thương hiệu'}</div>
                    <h3 class="product-name">${product.name}</h3>
                    <div class="product-price">
                        <span class="current-price">${product.price.toLocaleString()}đ</span>
                        ${originalPrice}
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-primary" onclick="addToCart(${product.id})">Thêm Vào Giỏ</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// ====== LOAD PRODUCTS FOR EACH CATEGORY ======
function loadShopProducts() {
    const allProducts = getAllProducts();
    displayProducts(allProducts, 'shop');
}

function loadNamProducts() {
    const namProducts = getAllProducts().filter(p => p.category === 'nam');
    displayProducts(namProducts, 'nam');
}

function loadNuProducts() {
    const nuProducts = getAllProducts().filter(p => p.category === 'nu');
    displayProducts(nuProducts, 'nu');
}

function loadTreEmProducts() {
    const treEmProducts = getAllProducts().filter(p => p.category === 'tre-em');
    displayProducts(treEmProducts, 'tre-em');
}

function loadPhuKienProducts() {
    const phuKienProducts = getAllProducts().filter(p => p.category === 'phu-kien');
    displayProducts(phuKienProducts, 'phu-kien');
}

// ====== CHECKOUT FUNCTIONS ======
function renderCheckoutItems() {
    const checkoutItemsContainer = document.getElementById('checkoutOrderItems');
    
    if (!checkoutItemsContainer) return;
    
    if (cart.length === 0) {
        checkoutItemsContainer.innerHTML = '<p>Không có sản phẩm trong giỏ hàng</p>';
        return;
    }
    
    checkoutItemsContainer.innerHTML = cart.map(item => `
        <div class="order-summary-item">
            <span>${item.name} x ${item.quantity}</span>
            <span>${(item.price * item.quantity).toLocaleString()}đ</span>
        </div>
    `).join('');
}

// ====== AUTH FUNCTIONS - SỬA RECAPTCHA MESSAGE ======
function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showNotification('Vui lòng nhập đầy đủ thông tin');
        return;
    }
    
    // Giả lập đăng nhập thành công
    currentUser = {
        name: "Nguyễn Văn A",
        email: email,
        phone: "0941552919"
    };
    
    localStorage.setItem('pandabeo_user', JSON.stringify(currentUser));
    updateUserInfo();
    closeAuthModal();
    showNotification('Đăng nhập thành công!');
}

// ====== PAGE NAVIGATION - ĐẢM BẢO TẤT CẢ TRANG ĐƯỢC TẢI ======
function showPage(page) {
    // Ẩn tất cả các trang
    document.querySelectorAll('.page').forEach(p => {
        p.classList.remove('active');
    });
    
    // Cập nhật active menu
    document.querySelectorAll('.nav-menu a').forEach(link => {
        link.classList.remove('active');
    });
    
    // Hiển thị trang được chọn
    const pageElement = document.getElementById(page + '-page');
    if (pageElement) {
        pageElement.classList.add('active');
    } else {
        console.error('Page not found:', page);
        return;
    }
    
    // Cập nhật active menu
    const activeLink = document.querySelector(`.nav-menu a[onclick*="${page}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
    }
    
    currentPage = page;
    
    // Load sản phẩm cho trang tương ứng
    switch(page) {
        case 'home':
            // Trang chủ không có sản phẩm
            break;
        case 'shop':
            loadShopProducts();
            break;
        case 'nam':
            loadNamProducts();
            break;
        case 'nu':
            loadNuProducts();
            break;
        case 'tre-em':
            loadTreEmProducts();
            break;
        case 'phu-kien':
            loadPhuKienProducts();
            break;
        case 'checkout':
            renderCheckoutItems();
            updateCheckoutSummary();
            break;
    }
    
    // Scroll lên đầu trang
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ====== FILTER FUNCTIONS - SỬA LỖI FILTER ======
function applyFilters(page = 'shop') {
    // Hiển thị loading
    const productGrid = document.getElementById(page + 'ProductGrid');
    if (productGrid) {
        productGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem;"><div class="loading-spinner"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i><p style="margin-top: 1rem;">Đang tải sản phẩm...</p></div></div>';
    }
    
    // Filter sản phẩm dựa trên activeFilters
    const filteredProducts = getFilteredProducts(page);
    
    // Cập nhật UI
    displayProducts(filteredProducts, page);
}

// ====== PRODUCT DETAIL FUNCTIONS ======
function showProductDetail(productId) {
    const product = getAllProducts().find(p => p.id === productId);
    if (!product) {
        showNotification('Không tìm thấy sản phẩm');
        return;
    }
    
    // Hiển thị trang chi tiết sản phẩm
    showPage('product-detail');
    
    // Render chi tiết sản phẩm
    const detailContent = document.getElementById('productDetailContent');
    if (!detailContent) {
        console.error('Product detail content not found');
        return;
    }
    
    // Đảm bảo có ảnh
    const mainImage = product.images && product.images[0] ? product.images[0] : 
        'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80';
    
    detailContent.innerHTML = `
        <div class="product-gallery">
            <div class="main-image">
                <img src="${mainImage}" alt="${product.name}" id="mainProductImage">
            </div>
            <div class="thumbnail-images">
                ${product.images ? product.images.map((img, index) => `
                    <div class="thumbnail ${index === 0 ? 'active' : ''}" onclick="changeProductImage('${img}')">
                        <img src="${img}" alt="${product.name}">
                    </div>
                `).join('') : ''}
            </div>
        </div>
        <div class="product-info-detail">
            <h1 class="product-title">${product.name}</h1>
            <div class="product-sku">SKU: PB${product.id}</div>
            <div class="product-price-detail">${product.price.toLocaleString()}đ</div>
            ${product.originalPrice && product.originalPrice > product.price ? 
                `<div class="original-price-detail">${product.originalPrice.toLocaleString()}đ</div>` : ''}
            
            ${product.colors && product.colors.length > 0 ? `
            <div class="color-options-detail">
                <h4>Màu sắc: <span id="selectedColorName">${product.colors[0].name}</span></h4>
                <div class="color-select">
                    ${product.colors.map((color, index) => `
                        <div class="color-circle ${index === 0 ? 'active' : ''}" 
                             style="background-color: ${color.code};"
                             onclick="selectColor('${color.name}', '${color.code}')"
                             title="${color.name}"></div>
                    `).join('')}
                </div>
            </div>` : ''}
            
            ${product.sizes && product.sizes.length > 0 ? `
            <div class="size-options">
                <h4>Kích cỡ:</h4>
                <div class="size-select">
                    ${product.sizes.map((size, index) => `
                        <button class="size-btn ${index === 0 ? 'active' : ''}" onclick="selectSize('${size}')">${size}</button>
                    `).join('')}
                </div>
            </div>` : ''}
            
            <div class="quantity-selector">
                <h4>Số lượng:</h4>
                <div class="quantity-control-detail">
                    <button class="qty-btn" onclick="changeQuantity(-1)">-</button>
                    <input type="number" class="qty-input" value="1" id="productQuantity" min="1">
                    <button class="qty-btn" onclick="changeQuantity(1)">+</button>
                </div>
            </div>
            
            <div class="product-actions-detail">
                <button class="btn btn-primary" onclick="addToCartFromDetail(${product.id})">THÊM VÀO GIỎ HÀNG</button>
                <button class="btn btn-outline" onclick="buyNow(${product.id})">MUA NGAY</button>
            </div>
            
            <div class="product-meta">
                <div class="meta-item">
                    <span class="meta-label">Thương hiệu:</span>
                    <span>${product.brand || 'Không rõ'}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Chất liệu:</span>
                    <span>${product.material || 'Không rõ'}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Xuất xứ:</span>
                    <span>${product.origin || 'Việt Nam'}</span>
                </div>
            </div>
            
            <div class="product-description">
                <h3>Mô tả sản phẩm</h3>
                <p>${product.description || 'Đang cập nhật...'}</p>
            </div>
        </div>
    `;
}

// ====== UPDATE CART COUNT ======
function updateCartCount() {
    const count = cart.reduce((total, item) => total + item.quantity, 0);
    document.getElementById('cartCount').textContent = count;
}

// ====== SHOW NOTIFICATION ======
function showNotification(message) {
    // Tạo notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: var(--primary);
        color: white;
        padding: 15px 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow-hover);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease;
    `;
    
    notification.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(notification);
    
    // Tạo keyframe animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    // Xóa sau 3 giây
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease forwards';
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
            if (style.parentNode) {
                style.remove();
            }
        }, 300);
    }, 3000);
}
